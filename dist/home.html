<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>WeatherWardrobe</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,700">
    <!-- https://fonts.google.com/specimen/Roboto -->
    <link rel="stylesheet" href="css/fontawesome.min.css">
    <!-- https://fontawesome.com/ -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <!-- https://getbootstrap.com/ -->
    <link rel="stylesheet" href="css/templatemo-style.css">
    <!--
	Product Admin CSS Template
	https://templatemo.com/tm-524-product-admin
	-->
    <style>
        /* Provided CSS styles */
        *
        :root {
        --white: #ffffff;
        --off-white: #e5e5e5;
        --transp-white-1: rgba(255, 255, 255, 0.25);
        --transp-white-2: rgba(255, 255, 255, 0.1);
        --blue-1: #62b8f5;
        --blue-2: #4475ef;
        --shadow: rgba(3, 46, 87, 0.2);
      }
      .container {
        width: 100%;
        background: var(--transp-white-2);
        backdrop-filter: blur(10px);
        padding: 3em 1.8em;
        border: 2px solid var(--transp-white-2);
        border-radius: 0.6em;
        box-shadow: 0 1.8em 3.7em var(--shadow);
        text-align: center;
      }
      .shape {
        position: absolute;
        background-color: var(--transp-white-1);
        backdrop-filter: blur(1.2em);
        border: 2px solid var(--transp-white-2);
        border-radius: 50%;
      }
      .shape-1 {
        height: 13em;
        width: 13em;
        right: -6.5em;
        top: 1.8em;
      }
      .shape-2 {
        height: 11em;
        width: 11em;
        bottom: -3.7em;
        left: -2.5em;
      }
      .search-container {
        font-size: 1em;
        display: grid;
        grid-template-columns: 9fr 3fr;
        gap: 1.25em;
      }
      .search-container input,
      .search-container button {
        outline: none;
        font-size: 1em;
        border: none;
      }
      .search-container input {
        padding: 0.7em;
        background-color: transparent;
        border-bottom: 2px solid var(--transp-white-1);
        color: var(--white);
        font-weight: 300;
      }
      .search-container input::placeholder {
        color: var(--off-white);
      }
      .search-container input:focus {
        border-color: var(--white);
      }
      .search-container button {
        color: var(--blue-2);
        background-color: var(--white);
        border-radius: 0.3em;
      }
      #result h2 {
        color: var(--white);
        text-transform: uppercase;
        letter-spacing: 0.18em;
        font-weight: 100;
        margin: 1.25em 0;
      }
      .weather,
      .desc {
        color: var(--off-white);
        text-transform: uppercase;
        letter-spacing: 0.2em;
        font-size: 0.9em;
        font-weight: 500;
        line-height: 2em;
      }
      .weather {
        margin-top: -0.7em;
      }
      #result img {
        margin: 0.6em 0 0 0;
        width: 6.2em;
        filter: drop-shadow(0 1.8em 3.7em var(--shadow));
      }
      #result h1 {
        font-size: 1em;
        margin: 0.3em 0 0.7em 0;
        line-height: 0;
        font-weight: 400;
        color: var(--white);
      }
      .temp-container {
        display: flex;
        justify-content: center;
      }
      .temp-container div {
        padding: 0.3em 1em;
      }
      .temp-container div:first-child {
        border-right: 1px solid var(--transp-white-1);
      }
      .temp-container .title {
        font-weight: 600;
        color: var(--white);
      }
      .temp-container .temp {
        font-weight: 300;
        color: var(--off-white);
      }
      .msg {
        margin-top: 1.8em;
        color: var(--white);
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.1em;
      }
      @media screen and (max-width: 450px) {
        .wrapper {
          font-size: 14px;
        }
      }
    </style>
</head>

<body id="reportsPage">
    <div class="" id="home">
        <nav class="navbar navbar-expand-xl">
            <div class="container h-100">
                <a class="navbar-brand" href="home.html">
                    <h1 class="tm-site-title mb-0">WeatherWardrobe</h1>
                </a>
                <button class="navbar-toggler ml-auto mr-0" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
                    aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <i class="fas fa-bars tm-nav-icon"></i>
                </button>

                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav mx-auto h-100">
                        <li class="nav-item">
                            <a class="nav-link active" href="#">
                                <i class="fas fa-tachometer-alt"></i>
                                Dashboard
                                <span class="sr-only">(current)</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="products.html">
                                <i class="fas fa-shopping-cart"></i>
                                Clothes
                            </a>
                        </li>
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link d-block" href="login.html">
                                Admin, <b>Logout</b>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

        </nav>
        <div class="container">
            <div class="row">
                <div class="col">
                    <p class="text-white mt-5 mb-5"><b></b></p>
                </div>
            </div>
            <!-- row -->
            <div class="row tm-content-row">
                <div class="col-sm-12 col-md-12 col-lg-6 col-xl-6 tm-block-col">
                    <div class="tm-bg-primary-dark tm-block tm-block-taller">
                        <h2 class="tm-block-title">Outfit</h2>
                        <div id="barChart" style="width:100%; height:100%;"></div>
                    </div>
                </div>
                <div class="col-sm-12 col-md-12 col-lg-6 col-xl-6 tm-block-col">
                    <div class="tm-bg-primary-dark tm-block tm-block-taller">
                        <h2 class="tm-block-title">Clothes Category</h2>
                        <div id="pieChart"></div>
                        <div id="pieChartContainer">
                        </div>
                    </div>
                </div>
                <div class="col-sm-12 col-md-6 col-lg-6 col-xl-6 tm-block-col">
                    <div class="tm-bg-primary-dark tm-block tm-block-taller tm-block-overflow">
                      <h2 class="tm-block-title">Notification List</h2>
                      <div class="tm-notification-items" id="notificationList">
                        <!-- The modified notification element will be inserted here dynamically -->
                      </div>
                    </div>
                  </div>


                  <div class="col-sm-12 col-md-6 col-lg-6 col-xl-6 tm-block-col">
                    <div class="tm-bg-primary-dark tm-block tm-block-taller tm-block-overflow">
                        <h2 class="tm-block-title">Weather and Covid Widget</h2>
                        <div class="tm-notification-items">
                                <div class="container">
                                    <div id="result" class="weather-widget"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>                
            </div>
        </div>
        <div class="col-12 tm-block-col">
            <div class="tm-bg-primary-dark tm-block tm-block-taller tm-block-scroll">
                <h2 class="tm-block-title">Suggestion Text Box</h2>
                <table class="table">
                    <thead>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    <script src="js/jquery-3.3.1.min.js"></script>
    <!-- https://jquery.com/download/ -->
    <script src="js/moment.min.js"></script>
    <!-- https://momentjs.com/ -->
    <script src="js/Chart.min.js"></script>
    <!-- http://www.chartjs.org/docs/latest/ -->
    <script src="js/bootstrap.min.js"></script>
    <!-- https://getbootstrap.com/ -->
    <script src="js/tooplate-scripts.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script>
        Chart.defaults.global.defaultFontColor = 'white';
        let ctxLine,
        ctxBar,
        ctxPie,
        optionsLine,
        optionsBar,
        optionsPie,
        configLine,
        configBar,
        configPie,
        lineChart,
        barChart,
        pieChart;
        // DOM is ready
        $(function () {
            drawBarChart(); // Bar Chart
            drawPieChart(); // Pie Chart

            $(window).resize(function () {
                updateBarChart();                
            });
        })
    </script>
</body>
</html>
<script type="module">

  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-analytics.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore.js";
  import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-database.js";

  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
  apiKey: "AIzaSyCmnqjXlksqhtHumP8WyKcTMsJ_hY7ys2E",
  authDomain: "faheemfirebase-7e868.firebaseapp.com",
  projectId: "faheemfirebase-7e868",
  storageBucket: "faheemfirebase-7e868.appspot.com",
  messagingSenderId: "804165468060",
  appId: "1:804165468060:web:a6f9a3c79013605c9dd259",
  measurementId: "G-FEG0FPGY1W"
};
  
  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  console.log(app);

  // Get a reference to the database
const database = getDatabase(app);

// Create a reference to the "Node1" node
const node1Ref = ref(database, 'Node1');

// Listen for changes in the database using the onValue function
onValue(node1Ref, (snapshot) => {
  const nodeData = snapshot.val();
  const motionTime = nodeData.motionTime;

  // Call the addNotification function with the motionTime data
  addNotification(`${motionTime}`);
});

//----------------------------Notification list--------------------------------------//

let notificationCount = 0;
let lastMotionDetection = '';

function addNotification(message, motionTime) {
  const notificationList = document.getElementById("notificationList");

  // Check if the new message is the same as the last motion detection
  if (message === lastMotionDetection) {
    return;
  }

  // Create a new notification element
  const notificationElement = document.createElement("div");
  notificationElement.classList.add("media", "tm-notification-item");

  // Create the avatar image container
  const avatarContainer = document.createElement("div");
    avatarContainer.classList.add("tm-gray-circle");

    const avatarImage = document.createElement("img");
    avatarImage.src = "img/noti.jpg"; // Replace with the actual logo image source
    avatarImage.alt = "Weather Logo";
    avatarImage.style.borderRadius = "50%"; // Apply the rounded shape to the image
    avatarImage.style.width = "100%"; // Set the width to 100% to fill the container
    avatarImage.style.height = "100%"; // Set the height to 100% to fill the container
    avatarImage.style.objectFit = "cover"; // Make the image fit inside the container


  // Append the avatar image to the container
  avatarContainer.appendChild(avatarImage);

  // Create the notification content container
  const notificationContent = document.createElement("div");
  notificationContent.classList.add("media-body");

  // Create the notification message
  const notificationMessage = document.createElement("p");
  notificationMessage.classList.add("mb-2");
  notificationMessage.innerHTML = `<b>Motion detected in the wardrobe:</b> ${message}`;

  // Create the timestamp element
  const timestamp = document.createElement("span");
  timestamp.classList.add("tm-small", "tm-text-color-secondary");
  timestamp.textContent = getCurrentTime(motionTime);

  // Append the message and timestamp to the content container
  notificationContent.appendChild(notificationMessage);
  notificationContent.appendChild(timestamp);

  // Append the avatar container and content container to the notification element
  notificationElement.appendChild(avatarContainer);
  notificationElement.appendChild(notificationContent);

  // Insert the new notification at the top of the list
  notificationList.insertBefore(notificationElement, notificationList.firstChild);

  // Increment the notification count
  notificationCount++;

  // Check if the notification count exceeds ten
  if (notificationCount > 10) {
    // Remove the oldest notification
    const lastNotification = notificationList.lastChild;
    notificationList.removeChild(lastNotification);

    // Decrement the notification count
    notificationCount--;
  }

  // Update the last motion detection message
  lastMotionDetection = message;
}

// Helper function to get the current time in the desired format
function getCurrentTime(motionTime) {
  const now = new Date();
  const motionTimestamp = new Date(motionTime);
  const timeDiff = Math.abs(now - motionTimestamp) / 1000; // Time difference in seconds

  if (timeDiff < 10) {
    return 'Just now';
  } else {
    const seconds = Math.floor(timeDiff % 60);
    const minutes = Math.floor((timeDiff / 60) % 60);
    const hours = Math.floor(timeDiff / 3600);

    if (hours > 0) {
      return `${hours} hour${hours > 1 ? 's' : ''} ago`;
    } else if (minutes > 0) {
      return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
    } else {
      return `${seconds} second${seconds > 1 ? 's' : ''} ago`;
    }
  }
}

//----------------------------Bar Chart--------------------------------------//
  $(function () {
            drawBarChart(); // Bar Chart
            // ... other function calls ...
        })

  async function fetchOutfitData() {
    const db = getFirestore(app);
    const querySnapshot = await getDocs(collection(db, "clothes"));
    let outfitData = {
        SunnyComfort: 0,
        LightLayers: 0,
        CloudyWarmth: 0,
        CloudyCover: 0,
        LightRainGear: 0,
        RainyProtection: 0,
        ThunderstormSafety: 0
    };

    querySnapshot.forEach((doc) => {
        const data = doc.data();
        if (data.outfit in outfitData) {
            outfitData[data.outfit]++;
        }
    });

    return outfitData;
}

async function drawBarChart() {
    const outfitData = await fetchOutfitData();

    const colors = ['#33b2df', '#546E7A', '#d4526e', '#13d8aa', '#A5978B', '#2b908f', '#f9a3a4', '#90ee7e', '#f48024', '#69d2e7'];

    var options = {
        series: [{
            data: Object.values(outfitData)
        }],
        chart: {
            type: 'bar',
            height: 380
        },
        plotOptions: {
            bar: {
                barHeight: '100%',
                distributed: true,
                horizontal: true,
                dataLabels: {
                    position: 'bottom'
                },
            }
        },
        colors: colors.slice(0, Object.keys(outfitData).length),
        dataLabels: {
            enabled: true,
            textAnchor: 'start',
            style: {
                colors: ['#fff']
            },
            formatter: function (val, opt) {
                return opt.w.globals.labels[opt.dataPointIndex] + ":  " + val
            },
            offsetX: 0,
            dropShadow: {
                enabled: true
            }
        },
        stroke: {
            width: 1,
            colors: ['#fff']
        },
        xaxis: {
            categories: Object.keys(outfitData),
        },
        yaxis: {
            labels: {
                show: false
            }
        },
        tooltip: {
            theme: 'dark',
            x: {
                show: false
            },
            y: {
                title: {
                    formatter: function () {
                        return ''
                    }
                }
            }
        }
    };

    var chart = new ApexCharts(document.querySelector("#barChart"), options);
    chart.render();
}
//----------------------------Pie chart--------------------------------------//
async function fetchClothesData() {
    const db = getFirestore(app);
    const querySnapshot = await getDocs(collection(db, "clothes"));
    let clothesData = {
        Top: 0,
        Bottom: 0,
        FootWear: 0
    };

    querySnapshot.forEach((doc) => {
        const data = doc.data();
        console.log(data);  // This line is for debugging.
        if (data.clothes in clothesData) {
            clothesData[data.clothes]++;
        }
    });

    return clothesData;
}

async function drawPieChart() {
    const categoryData = await fetchClothesData();
    console.log("Category data in drawPieChart:", categoryData);  // This line is for debugging.

    var options = {
        series: Object.values(categoryData),
        chart: {
            width: 380,
            type: 'pie',
        },
        labels: Object.keys(categoryData),
        responsive: [{
            breakpoint: 480,
            options: {
                chart: {
                    width: 300  // Increase this size for smaller screens.
                },
                legend: {
                    position: 'bottom'
                }
            }
        }]
    };

    var chart = new ApexCharts(document.querySelector("#pieChart"), options);
    chart.render();
}
//---------------------------Weather and covid Widget-------------------------------------//
      // JavaScript code goes here
      let result = document.getElementById("result");

      //Assign the API key to the 'key' variable
      let key = "95717a9201c41471bd9b668d0440c089";

      // Function to fetch weather details for Iligan City from the API and display them
      let getWeather = () => {
        let cityValue = "Iligan City"; // Set the city name to "Iligan City"

        let url = `https://api.openweathermap.org/data/2.5/weather?q=${cityValue}&appid=${key}&units=metric`;
       // let covidUrl = "https://covid19-api-philippines.herokuapp.com/api/top-regions";

        fetch(url)
          .then((resp) => resp.json())
          .then((weatherData) => {
            // Constant COVID-19 data for Northern Mindanao
          // Find the COVID-19 data for Northern Mindanao
         // let regionData = covidData.find((region) => region.region === "Region X: Northern Mindanao");

            let covidData = {
              region: "Region X: Northern Mindanao",
              cases: 1388,
              recovered: 765,
              deaths: 17
            };

            console.log(weatherData);
            console.log(weatherData.weather[0].icon);
            console.log(weatherData.weather[0].main);
            console.log(weatherData.weather[0].description);
            console.log(weatherData.name);
            console.log(weatherData.main.temp_min);
            console.log(weatherData.main.temp_max);

            result.innerHTML = `
              <h2>${weatherData.name}</h2>
              <h4 class="weather">${weatherData.weather[0].main}</h4>
              <h4 class="desc">${weatherData.weather[0].description}</h4>
              <img src="https://openweathermap.org/img/w/${weatherData.weather[0].icon}.png">
              <h1>${weatherData.main.temp} &#176;</h1>
              <h3 style="color: white;">COVID-19 Data</h3>
              <div class="temp-container">
                <div>
                  <h4 class="title">Cases:</h4>
                  <h4 class="temp">${covidData.cases}</h4>
                </div>
                <div>
                  <h4 class="title">Recovery:</h4>
                  <h4 class="temp">${covidData.recovered}</h4>
                </div>
              </div>
            `;
          })
          .catch(() => {
            result.innerHTML = `<h3 class="msg">City not found</h3>`;
          });
      };

      // Call the getWeather function initially and periodically
      getWeather(); // Call initially

      // Refresh weather every 10 minutes (600,000 milliseconds)
      setInterval(getWeather, 600000);

$(function () {
    drawPieChart(); // Pie Chart
    // ... other function calls ...
})
</script>